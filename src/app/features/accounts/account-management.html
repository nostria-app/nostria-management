<div class="account-management">
  <h1>Account Management</h1>
  
  <!-- Subscription Tiers Section -->
  <section class="tiers-section">
    <h2>Subscription Tiers</h2>
    <div class="tiers-grid">
      @for (tier of tiersArray(); track tier.tier) {
        <div class="tier-card" [class.premium]="tier.tier !== 'free'">
          <h3>{{ tier.name }}</h3>
          <div class="tier-info">
            <span class="tier-type">{{ tier.tier }}</span>
            <div class="pricing">
              @if (tier.pricing.monthly) {
                <div class="price">
                  <span class="amount">${{ formatPrice(tier.pricing.monthly.priceCents) }}</span>
                  <span class="period">/month</span>
                </div>
              }
              @if (tier.pricing.yearly) {
                <div class="price annual">
                  <span class="amount">${{ formatPrice(tier.pricing.yearly.priceCents) }}</span>
                  <span class="period">/year</span>
                </div>
              }
            </div>
            <div class="features">
              <p><strong>Notifications per day:</strong> {{ tier.entitlements.notificationsPerDay }}</p>
              <div class="feature-list">
                @for (feature of tier.entitlements.features; track feature.key) {
                  <span class="feature-tag">{{ feature.label }}</span>
                }
              </div>
            </div>
          </div>
        </div>
      }
    </div>
    @if (tiersLoading()) {
      <div class="loading">Loading subscription tiers...</div>
    }
    @if (tiersError()) {
      <div class="error">Error loading tiers: {{ tiersError() }}</div>
    }
  </section>

  <!-- Account Creation Section -->
  <section class="account-creation">
    <h2>Create Account</h2>
    <form [formGroup]="createAccountForm" (ngSubmit)="createAccount()">
      <div class="form-group">
        <label for="pubkey">Public Key *</label>
        <input 
          id="pubkey" 
          type="text" 
          formControlName="pubkey"
          placeholder="Enter public key in hex format"
          maxlength="64"
        >
        @if (createAccountForm.get('pubkey')?.errors?.['required'] && createAccountForm.get('pubkey')?.touched) {
          <div class="error">Public key is required</div>
        }
        @if (createAccountForm.get('pubkey')?.errors?.['pattern'] && createAccountForm.get('pubkey')?.touched) {
          <div class="error">Invalid public key format (must be 64 hex characters)</div>
        }
      </div>
      
      <div class="form-group">
        <label for="username">Username (optional)</label>
        <input 
          id="username" 
          type="text" 
          formControlName="username"
          placeholder="Choose a username"
        >
        <button type="button" class="check-btn" (click)="checkUsername()" [disabled]="!createAccountForm.get('username')?.value">
          Check Availability
        </button>
      </div>
      
      <div class="form-group">
        <label for="paymentId">Payment ID (optional)</label>
        <input 
          id="paymentId" 
          type="text" 
          formControlName="paymentId"
          placeholder="Payment ID for premium subscription"
        >
      </div>
      
      <button type="submit" [disabled]="createAccountForm.invalid || isCreatingAccount()" class="primary-btn">
        @if (isCreatingAccount()) {
          Creating...
        } @else {
          Create Account
        }
      </button>
    </form>
    
    @if (createAccountError()) {
      <div class="error">{{ createAccountError() }}</div>
    }
    @if (createAccountSuccess()) {
      <div class="success">Account created successfully!</div>
    }
  </section>

  <!-- Username Check Results -->
  @if (usernameCheckResult()) {
    <section class="username-check">
      <h3>Username Check Result</h3>
      <div [class]="usernameCheckResult()?.success ? 'success' : 'error'">
        {{ usernameCheckResult()?.message || 'Username check completed' }}
      </div>
    </section>
  }

  <!-- Account Lookup Section -->
  <section class="account-lookup">
    <h2>Account Lookup</h2>
    <div class="lookup-form">
      <input 
        type="text" 
        [(ngModel)]="lookupQuery"
        placeholder="Enter public key or username"
        class="lookup-input"
      >
      <button (click)="lookupAccount()" [disabled]="!lookupQuery || isLookingUp()" class="secondary-btn">
        @if (isLookingUp()) {
          Looking up...
        } @else {
          Lookup Account
        }
      </button>
    </div>
    
    @if (lookupResult()) {
      <div class="account-result">
        <h3>Account Information</h3>
        <div class="account-details">
          <p><strong>Public Key:</strong> {{ lookupResult()?.pubkey }}</p>
          @if (lookupResult()?.username) {
            <p><strong>Username:</strong> {{ lookupResult()?.username }}</p>
          }
          <p><strong>Tier:</strong> {{ lookupResult()?.tier }}</p>
          <p><strong>Active:</strong> {{ lookupResult()?.isActive ? 'Yes' : 'No' }}</p>
          <p><strong>Signup Date:</strong> {{ formatDate(lookupResult()?.signupDate) }}</p>
        </div>
      </div>
    }
    
    @if (lookupError()) {
      <div class="error">{{ lookupError() }}</div>
    }
  </section>

  <!-- Current Account Section (if authenticated) -->
  @if (currentAccount()) {
    <section class="current-account">
      <h2>Current Account</h2>
      <div class="account-info">
        <p><strong>Public Key:</strong> {{ currentAccount()?.pubkey }}</p>
        @if (currentAccount()?.username) {
          <p><strong>Username:</strong> {{ currentAccount()?.username }}</p>
        }
        <p><strong>Tier:</strong> {{ currentAccount()?.tier }}</p>
        <p><strong>Signup Date:</strong> {{ formatDate(currentAccount()?.signupDate) }}</p>
        @if (currentAccount()?.lastLoginDate) {
          <p><strong>Last Login:</strong> {{ formatDate(currentAccount()?.lastLoginDate) }}</p>
        }
        @if (currentAccount()?.expires) {
          <p><strong>Expires:</strong> {{ formatDate(currentAccount()?.expires) }}</p>
        }
        <div class="entitlements">
          <h4>Entitlements</h4>
          <p>Notifications per day: {{ currentAccount()?.entitlements?.notificationsPerDay }}</p>
          <div class="features">
            @for (feature of currentAccount()?.entitlements?.features; track feature.key) {
              <span class="feature-tag">{{ feature.label }}</span>
            }
          </div>
        </div>
      </div>
      
      <form [formGroup]="updateAccountForm" (ngSubmit)="updateAccount()">
        <h3>Update Account</h3>
        <div class="form-group">
          <label for="updateUsername">Username</label>
          <input 
            id="updateUsername" 
            type="text" 
            formControlName="username"
            placeholder="Enter new username"
          >
        </div>
        <button type="submit" [disabled]="updateAccountForm.invalid || isUpdatingAccount()" class="primary-btn">
          @if (isUpdatingAccount()) {
            Updating...
          } @else {
            Update Account
          }
        </button>
      </form>
      
      @if (updateAccountError()) {
        <div class="error">{{ updateAccountError() }}</div>
      }
      @if (updateAccountSuccess()) {
        <div class="success">Account updated successfully!</div>
      }
    </section>
  }

  <!-- Account Listing Section -->
  <section class="account-listing">
    <div class="section-header">
      <h2>Account Directory</h2>
      <p class="section-subtitle">Browse account records using authenticated API access</p>
    </div>

    <!-- Nostr Connection Status -->
    <div class="nostr-status">
      @if (isNostrConnected()) {
        <div class="status-connected">
          <span class="icon">üîó</span>
          <span>Connected to Nostr extension</span>
          <button class="btn-secondary btn-sm" (click)="disconnectNostr()">Disconnect</button>
        </div>
      } @else {
        <div class="status-disconnected">
          <span class="icon">üîí</span>
          <span>Not connected to Nostr extension</span>
          @if (isNostrExtensionAvailable) {
            <button class="btn-primary btn-sm" (click)="connectToNostr()">Connect</button>
          } @else {
            <span class="error-text">No Nostr extension found. Please install nos2x, Alby, or similar.</span>
          }
        </div>
      }
    </div>

    <!-- List Accounts Form -->
    <form [formGroup]="listAccountsForm" (ngSubmit)="listAccounts()" class="form-container">
      <div class="form-group">
        <label for="accountLimit">Number of accounts to retrieve (max 1000):</label>
        <input
          type="number"
          id="accountLimit"
          formControlName="limit"
          min="1"
          max="1000"
          class="form-control"
        />
        @if (listAccountsForm.get('limit')?.invalid && listAccountsForm.get('limit')?.touched) {
          <div class="form-error">Please enter a valid limit (1-1000)</div>
        }
      </div>

      <div class="form-actions">
        <button
          type="submit"
          class="btn-primary"
          [disabled]="listAccountsForm.invalid || isListingAccounts() || !isNostrConnected()"
        >
          @if (isListingAccounts()) {
            <span class="loading-spinner"></span>
            Authenticating & Loading...
          } @else {
            Sign Message & List Accounts
          }
        </button>
      </div>
    </form>

    <!-- List Accounts Error -->
    @if (listAccountsError()) {
      <div class="error">
        <span class="icon">‚ö†Ô∏è</span>
        {{ listAccountsError() }}
      </div>
    }

    <!-- Account Directory -->
    @if (listedAccounts().length > 0) {
      <div class="results">
        <h3>Account Directory ({{ listedAccounts().length }} accounts)</h3>
        <div class="accounts-table-detailed">
          @for (account of listedAccounts(); track account.pubkey) {
            <div class="account-card">
              <!-- Header with Pubkey and Status -->
              <div class="account-header">
                <div class="account-pubkey-section">
                  <label>Public Key:</label>
                  <div class="pubkey-container">
                    <a 
                      href="https://nostria.app/p/{{ account.pubkey }}" 
                      target="_blank" 
                      rel="noopener noreferrer"
                      class="pubkey-link"
                      title="View user profile on Nostria"
                    >
                      {{ account.pubkey.substring(0, 8) }}...{{ account.pubkey.substring(56) }}
                    </a>
                    <button 
                      class="btn-sm btn-outline copy-btn" 
                      (click)="copyToClipboard(account.pubkey)"
                      title="Copy Public Key"
                    >
                      üìã
                    </button>
                  </div>
                </div>
                <span class="tier-badge" [class]="getAccountStatusClass(account)">
                  {{ getTierDisplayName(account.tier) }}
                </span>
              </div>

              <!-- Account Details Grid -->
              <div class="account-details">
                <!-- First Row: Username, Tier, Status -->
                <div class="detail-row">
                  <div class="detail-item">
                    <label>Username:</label>
                    <span class="username">
                      @if (account.username) {
                        {{ account.username }}
                      } @else {
                        <em class="no-username">No username set</em>
                      }
                    </span>
                  </div>
                  <div class="detail-item">
                    <label>Subscription:</label>
                    <span class="tier-info">{{ getTierDisplayName(account.tier) }}</span>
                  </div>
                  <div class="detail-item">
                    <label>Notifications/Day:</label>
                    <span class="notifications">{{ account.entitlements.notificationsPerDay }}</span>
                  </div>
                </div>

                <!-- Second Row: Dates -->
                <div class="detail-row">
                  <div class="detail-item">
                    <label>Signup Date:</label>
                    <span class="timestamp">{{ formatDate(account.signupDate) }}</span>
                  </div>
                  @if (account.lastLoginDate) {
                    <div class="detail-item">
                      <label>Last Login:</label>
                      <span class="timestamp">{{ formatDate(account.lastLoginDate) }}</span>
                    </div>
                  }
                  @if (account.expires) {
                    <div class="detail-item">
                      <label>Expires:</label>
                      <span class="timestamp" [class.expired]="isAccountExpired(account.expires)">
                        {{ formatDate(account.expires) }}
                        @if (!isAccountExpired(account.expires)) {
                          <br><small class="expiry-countdown">({{ getTimeUntilExpiration(account.expires) }})</small>
                        }
                      </span>
                    </div>
                  }
                </div>

                <!-- Features Row -->
                <div class="detail-row">
                  <div class="detail-item full-width">
                    <label>Features:</label>
                    <div class="features-list">
                      @for (feature of account.entitlements.features; track feature.key) {
                        <span class="feature-tag">{{ feature.label }}</span>
                      }
                    </div>
                  </div>
                </div>
              </div>

              <!-- Actions -->
              <div class="account-actions">
                <a 
                  href="https://nostria.app/p/{{ account.pubkey }}" 
                  target="_blank" 
                  rel="noopener noreferrer"
                  class="btn-sm btn-primary"
                  title="View Profile on Nostria"
                >
                  üë§ View Profile
                </a>
                <button 
                  class="btn-sm btn-outline" 
                  (click)="copyToClipboard(account.pubkey)"
                  title="Copy Public Key"
                >
                  üìã Copy Pubkey
                </button>
                @if (account.username) {
                  <button 
                    class="btn-sm btn-outline" 
                    (click)="copyToClipboard(account.username)"
                    title="Copy Username"
                  >
                    üìã Copy Username
                  </button>
                }
              </div>
            </div>
          }
        </div>
      </div>
    } @else if (!isListingAccounts() && !listAccountsError()) {
      <div class="empty-state">
        <p>Connect your Nostr extension and click "Sign Message & List Accounts" to retrieve account records</p>
        <p><em>API endpoint: GET /api/account/list</em></p>
      </div>
    }
  </section>
</div>
